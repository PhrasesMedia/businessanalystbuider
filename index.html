<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Business Analyst Builder (BAB)</title>
<meta name="description" content="BAB ‚Äî Build clearer BA artefacts faster: stakeholder mapping, requirements, process flows, and delivery outputs." />
<style>
:root{
--sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
--mono: "SF Mono", Monaco, "Cascadia Code", "Roboto Mono", Consolas, "Courier New", monospace;

/* Enhanced color palette */
--bg-primary: #0a0e27;
--bg-secondary: #151933;
--bg-tertiary: #1a1f3a;
--surface: #1e2442;
--surface-hover: #252b4f;

--text-primary: #f5f7fa;
--text-secondary: #b8c5db;
--text-muted: #8891a8;

--accent-primary: #6366f1;
--accent-primary-light: #818cf8;
--accent-secondary: #22d3ee;
--accent-tertiary: #a78bfa;

--success: #10b981;
--warning: #f59e0b;
--danger: #ef4444;
--info: #3b82f6;

--border: rgba(255,255,255,.08);
--border-strong: rgba(255,255,255,.12);
--shadow-sm: 0 2px 8px rgba(0,0,0,.3);
--shadow-md: 0 8px 24px rgba(0,0,0,.4);
--shadow-lg: 0 16px 48px rgba(0,0,0,.5);

--radius-sm: 8px;
--radius-md: 12px;
--radius-lg: 16px;
--radius-xl: 20px;

--gap: 16px;
--gap-sm: 12px;
--gap-xs: 8px;

color-scheme: dark;
}

*{
box-sizing:border-box;
}

html, body{
height:100%;
margin:0;
}

body{
font-family: var(--sans);
color: var(--text-primary);
background: 
  radial-gradient(circle at 20% 10%, rgba(99,102,241,.12), transparent 50%),
  radial-gradient(circle at 80% 20%, rgba(34,211,238,.08), transparent 50%),
  radial-gradient(circle at 50% 80%, rgba(167,139,250,.06), transparent 50%),
  linear-gradient(180deg, var(--bg-primary), var(--bg-secondary));
background-attachment: fixed;
line-height: 1.6;
}

/* Scrollbar */
::-webkit-scrollbar {
width: 10px;
height: 10px;
}
::-webkit-scrollbar-track {
background: var(--bg-secondary);
}
::-webkit-scrollbar-thumb {
background: var(--surface);
border-radius: 5px;
}
::-webkit-scrollbar-thumb:hover {
background: var(--surface-hover);
}

/* Typography */
h1, h2, h3, h4, h5, h6 {
margin: 0;
font-weight: 700;
letter-spacing: -0.02em;
line-height: 1.2;
}

h1 { font-size: 2.5rem; }
h2 { font-size: 1.875rem; }
h3 { font-size: 1.5rem; }
h4 { font-size: 1.25rem; }
h5 { font-size: 1.125rem; }

/* Layout */
.container {
max-width: 1400px;
margin: 0 auto;
padding: 24px;
}

/* Header */
.header {
background: var(--surface);
border: 1px solid var(--border);
border-radius: var(--radius-xl);
padding: 20px 24px;
margin-bottom: 24px;
box-shadow: var(--shadow-md);
display: flex;
align-items: center;
justify-content: space-between;
gap: 24px;
flex-wrap: wrap;
}

.brand {
display: flex;
align-items: center;
gap: 16px;
}

.logo {
width: 48px;
height: 48px;
border-radius: var(--radius-md);
background: linear-gradient(135deg, var(--accent-primary), var(--accent-tertiary));
display: flex;
align-items: center;
justify-content: center;
font-size: 24px;
font-weight: 800;
color: white;
box-shadow: 0 4px 12px rgba(99,102,241,.3);
}

.brand-text h1 {
font-size: 1.5rem;
margin-bottom: 4px;
}

.brand-text p {
margin: 0;
color: var(--text-secondary);
font-size: 0.875rem;
}

.nav {
display: flex;
gap: 8px;
flex-wrap: wrap;
}

.nav-btn {
padding: 10px 18px;
border-radius: var(--radius-md);
border: 1px solid var(--border);
background: rgba(255,255,255,.03);
color: var(--text-secondary);
font-size: 0.875rem;
font-weight: 600;
cursor: pointer;
transition: all .2s ease;
white-space: nowrap;
}

.nav-btn:hover {
background: rgba(255,255,255,.06);
border-color: var(--border-strong);
color: var(--text-primary);
transform: translateY(-1px);
}

.nav-btn.active {
background: linear-gradient(135deg, var(--accent-primary), var(--accent-primary-light));
border-color: var(--accent-primary);
color: white;
box-shadow: 0 4px 12px rgba(99,102,241,.3);
}

/* Cards */
.card {
background: var(--surface);
border: 1px solid var(--border);
border-radius: var(--radius-xl);
box-shadow: var(--shadow-md);
overflow: hidden;
margin-bottom: 24px;
}

.card-header {
padding: 24px;
border-bottom: 1px solid var(--border);
background: linear-gradient(180deg, rgba(255,255,255,.02), transparent);
}

.card-title {
font-size: 1.5rem;
margin-bottom: 8px;
}

.card-subtitle {
color: var(--text-secondary);
font-size: 0.9375rem;
margin: 0;
}

.card-body {
padding: 24px;
}

/* Grid layouts */
.grid {
display: grid;
gap: var(--gap);
}

.grid-2 { grid-template-columns: repeat(2, 1fr); }
.grid-3 { grid-template-columns: repeat(3, 1fr); }
.grid-4 { grid-template-columns: repeat(4, 1fr); }

@media (max-width: 1024px) {
.grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
}

@media (min-width: 1025px) and (max-width: 1400px) {
.grid-3, .grid-4 { grid-template-columns: repeat(2, 1fr); }
}

/* Form elements */
.form-group {
margin-bottom: 20px;
}

label {
display: block;
font-size: 0.875rem;
font-weight: 600;
color: var(--text-secondary);
margin-bottom: 8px;
letter-spacing: 0.01em;
}

.input, select, textarea {
width: 100%;
padding: 12px 16px;
border-radius: var(--radius-md);
border: 1px solid var(--border);
background: var(--bg-secondary);
color: var(--text-primary);
font-size: 0.9375rem;
transition: all .2s ease;
outline: none;
font-family: var(--sans);
}

.input:focus, select:focus, textarea:focus {
border-color: var(--accent-primary);
background: var(--bg-tertiary);
box-shadow: 0 0 0 3px rgba(99,102,241,.1);
}

textarea {
resize: vertical;
min-height: 100px;
line-height: 1.6;
}

.input-hint {
font-size: 0.8125rem;
color: var(--text-muted);
margin-top: 6px;
line-height: 1.4;
}

/* Buttons */
.btn {
padding: 12px 20px;
border-radius: var(--radius-md);
border: 1px solid var(--border);
background: rgba(255,255,255,.05);
color: var(--text-primary);
font-size: 0.9375rem;
font-weight: 600;
cursor: pointer;
transition: all .2s ease;
display: inline-flex;
align-items: center;
gap: 8px;
white-space: nowrap;
}

.btn:hover {
background: rgba(255,255,255,.08);
border-color: var(--border-strong);
transform: translateY(-1px);
box-shadow: var(--shadow-sm);
}

.btn-primary {
background: linear-gradient(135deg, var(--accent-primary), var(--accent-primary-light));
border-color: var(--accent-primary);
color: white;
}

.btn-primary:hover {
box-shadow: 0 4px 12px rgba(99,102,241,.3);
}

.btn-success {
background: var(--success);
border-color: var(--success);
color: white;
}

.btn-danger {
background: var(--danger);
border-color: var(--danger);
color: white;
}

.btn-sm {
padding: 8px 14px;
font-size: 0.8125rem;
}

.btn-group {
display: flex;
gap: 12px;
flex-wrap: wrap;
margin-top: 16px;
}

/* Badges */
.badge {
display: inline-flex;
align-items: center;
gap: 6px;
padding: 6px 12px;
border-radius: 999px;
font-size: 0.75rem;
font-weight: 600;
border: 1px solid var(--border);
background: rgba(255,255,255,.05);
}

.badge-primary { background: rgba(99,102,241,.15); border-color: var(--accent-primary); color: var(--accent-primary-light); }
.badge-success { background: rgba(16,185,129,.15); border-color: var(--success); color: #6ee7b7; }
.badge-warning { background: rgba(245,158,11,.15); border-color: var(--warning); color: #fbbf24; }
.badge-danger { background: rgba(239,68,68,.15); border-color: var(--danger); color: #fca5a5; }
.badge-info { background: rgba(59,130,246,.15); border-color: var(--info); color: #93c5fd; }

/* Mini cards */
.mini-card {
padding: 20px;
border-radius: var(--radius-lg);
border: 1px solid var(--border);
background: linear-gradient(135deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
transition: all .2s ease;
cursor: pointer;
}

.mini-card:hover {
border-color: var(--border-strong);
background: linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
transform: translateY(-2px);
box-shadow: var(--shadow-md);
}

.mini-card h4 {
font-size: 1.125rem;
margin-bottom: 8px;
}

.mini-card p {
color: var(--text-secondary);
font-size: 0.875rem;
margin: 0;
}

/* Stakeholder specific styles */
.stakeholder-grid {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
gap: 16px;
}

.stakeholder-card {
padding: 16px;
border-radius: var(--radius-lg);
border: 1px solid var(--border);
background: var(--bg-tertiary);
transition: all .2s ease;
}

.stakeholder-card:hover {
border-color: var(--border-strong);
box-shadow: var(--shadow-sm);
}

.stakeholder-header {
display: flex;
justify-content: space-between;
align-items: flex-start;
margin-bottom: 12px;
}

.stakeholder-name {
font-weight: 700;
font-size: 1rem;
margin-bottom: 4px;
}

.stakeholder-role {
color: var(--text-secondary);
font-size: 0.8125rem;
}

.stakeholder-meta {
display: flex;
gap: 8px;
margin-top: 12px;
flex-wrap: wrap;
}

/* Influence/Impact Matrix */
.matrix-container {
width: 100%;
max-width: 800px;
margin: 24px auto;
position: relative;
background: white;
border-radius: var(--radius-lg);
padding: 60px 40px 40px 60px;
box-shadow: var(--shadow-lg);
}

.matrix-canvas {
width: 100%;
aspect-ratio: 1;
position: relative;
background: 
  linear-gradient(to right, rgba(59,130,246,.05) 0%, rgba(59,130,246,.05) 50%, rgba(16,185,129,.05) 50%, rgba(16,185,129,.05) 100%),
  linear-gradient(to bottom, rgba(245,158,11,.05) 0%, rgba(245,158,11,.05) 50%, transparent 50%, transparent 100%);
border: 2px solid #e5e7eb;
border-radius: var(--radius-md);
}

.matrix-grid {
position: absolute;
inset: 0;
background-image: 
  linear-gradient(to right, #e5e7eb 1px, transparent 1px),
  linear-gradient(to bottom, #e5e7eb 1px, transparent 1px);
background-size: 10% 10%;
opacity: 0.5;
pointer-events: none;
}

.matrix-crosshair {
position: absolute;
background: #f59e0b;
}

.matrix-crosshair-h {
left: 0;
right: 0;
top: 50%;
height: 2px;
transform: translateY(-50%);
}

.matrix-crosshair-v {
top: 0;
bottom: 0;
left: 50%;
width: 2px;
transform: translateX(-50%);
}

.matrix-labels {
position: absolute;
font-size: 0.75rem;
font-weight: 700;
color: #6b7280;
text-transform: uppercase;
letter-spacing: 0.05em;
}

.matrix-label-x {
bottom: -35px;
left: 50%;
transform: translateX(-50%);
}

.matrix-label-y {
left: -45px;
top: 50%;
transform: translateY(-50%) rotate(-90deg);
white-space: nowrap;
}

.matrix-corner-label {
position: absolute;
font-size: 0.7rem;
font-weight: 600;
color: #9ca3af;
}

.matrix-corner-tl {
top: 10px;
left: 10px;
}

.matrix-corner-tr {
top: 10px;
right: 10px;
}

.matrix-corner-bl {
bottom: 10px;
left: 10px;
}

.matrix-corner-br {
bottom: 10px;
right: 10px;
}

.stakeholder-marker {
position: absolute;
width: 48px;
height: 48px;
border-radius: 50%;
background: var(--accent-primary);
border: 3px solid white;
display: flex;
align-items: center;
justify-content: center;
color: white;
font-weight: 700;
font-size: 0.75rem;
cursor: pointer;
transition: all .2s ease;
transform: translate(-50%, -50%);
box-shadow: 0 2px 8px rgba(0,0,0,.15);
}

.stakeholder-marker:hover {
transform: translate(-50%, -50%) scale(1.2);
box-shadow: 0 4px 16px rgba(0,0,0,.25);
z-index: 10;
}

.stakeholder-marker-label {
position: absolute;
top: 100%;
left: 50%;
transform: translateX(-50%);
margin-top: 8px;
background: rgba(0,0,0,.85);
color: white;
padding: 4px 10px;
border-radius: 6px;
font-size: 0.7rem;
white-space: nowrap;
pointer-events: none;
opacity: 0;
transition: opacity .2s ease;
}

.stakeholder-marker:hover .stakeholder-marker-label {
opacity: 1;
}

.matrix-title {
position: absolute;
top: 20px;
left: 50%;
transform: translateX(-50%);
font-size: 1.125rem;
font-weight: 700;
color: #1f2937;
}

/* Engagement slider */
.engagement-track {
width: 100%;
height: 40px;
background: var(--bg-secondary);
border-radius: 999px;
position: relative;
overflow: hidden;
border: 1px solid var(--border);
margin: 16px 0;
}

.engagement-segments {
display: flex;
height: 100%;
}

.engagement-segment {
flex: 1;
display: flex;
align-items: center;
justify-content: center;
font-size: 0.75rem;
font-weight: 600;
border-right: 1px solid var(--border);
cursor: pointer;
transition: all .2s ease;
}

.engagement-segment:last-child { border-right: none; }

.engagement-segment:hover {
background: rgba(255,255,255,.05);
}

.engagement-segment.active {
background: var(--accent-primary);
color: white;
}

.engagement-unaware { color: var(--danger); }
.engagement-resistant { color: var(--warning); }
.engagement-neutral { color: var(--text-muted); }
.engagement-supportive { color: var(--success); }
.engagement-leading { color: var(--accent-primary-light); }

/* Modal */
.modal-backdrop {
position: fixed;
inset: 0;
background: rgba(0,0,0,.7);
backdrop-filter: blur(8px);
display: none;
align-items: center;
justify-content: center;
padding: 24px;
z-index: 1000;
}

.modal {
width: min(800px, 100%);
max-height: 90vh;
overflow-y: auto;
background: var(--surface);
border: 1px solid var(--border-strong);
border-radius: var(--radius-xl);
box-shadow: var(--shadow-lg);
}

.modal-header {
padding: 24px;
border-bottom: 1px solid var(--border);
display: flex;
justify-content: space-between;
align-items: flex-start;
gap: 16px;
}

.modal-title {
font-size: 1.5rem;
}

.modal-close {
width: 36px;
height: 36px;
border-radius: var(--radius-md);
border: 1px solid var(--border);
background: rgba(255,255,255,.05);
color: var(--text-primary);
cursor: pointer;
display: flex;
align-items: center;
justify-content: center;
font-size: 1.25rem;
transition: all .2s ease;
}

.modal-close:hover {
background: rgba(255,255,255,.08);
transform: rotate(90deg);
}

.modal-body {
padding: 24px;
}

/* Toast */
.toast {
position: fixed;
bottom: 24px;
left: 50%;
transform: translateX(-50%);
background: var(--surface);
border: 1px solid var(--border-strong);
border-radius: var(--radius-md);
padding: 12px 20px;
box-shadow: var(--shadow-lg);
color: var(--text-primary);
font-size: 0.875rem;
font-weight: 600;
display: none;
z-index: 1001;
max-width: 90%;
text-align: center;
}

/* Output display */
.output-container {
margin-top: 24px;
border-radius: var(--radius-lg);
border: 1px solid var(--border);
background: var(--bg-secondary);
overflow: hidden;
}

.output-header {
padding: 16px 20px;
border-bottom: 1px solid var(--border);
display: flex;
justify-content: space-between;
align-items: center;
gap: 16px;
flex-wrap: wrap;
background: rgba(255,255,255,.02);
}

.output-body {
padding: 20px;
font-family: var(--mono);
font-size: 0.8125rem;
line-height: 1.6;
white-space: pre-wrap;
word-break: break-word;
color: var(--text-secondary);
max-height: 600px;
overflow-y: auto;
}

/* Utilities */
.flex { display: flex; }
.flex-col { flex-direction: column; }
.items-center { align-items: center; }
.justify-between { justify-content: space-between; }
.gap-2 { gap: 8px; }
.gap-4 { gap: 16px; }
.mb-4 { margin-bottom: 16px; }
.mt-4 { margin-top: 16px; }
.text-muted { color: var(--text-muted); }
.text-sm { font-size: 0.875rem; }
.font-semibold { font-weight: 600; }

/* Responsive */
@media (max-width: 768px) {
.container { padding: 16px; }
.header { padding: 16px; }
.card-header, .card-body { padding: 16px; }
.brand { flex-direction: column; align-items: flex-start; }
.nav { width: 100%; }
.nav-btn { flex: 1; text-align: center; }
h1 { font-size: 1.75rem; }
h2 { font-size: 1.5rem; }
}

/* Icon placeholders */
.icon {
width: 20px;
height: 20px;
display: inline-block;
}

/* Empty state */
.empty-state {
padding: 60px 24px;
text-align: center;
color: var(--text-muted);
}

.empty-state h3 {
color: var(--text-secondary);
margin-bottom: 8px;
}

.empty-state p {
margin: 0 0 24px;
}

/* Organizational Chart */
.org-chart-container {
width: 100%;
overflow-x: auto;
padding: 40px 20px;
background: var(--bg-secondary);
border-radius: var(--radius-lg);
min-height: 400px;
}

.org-chart {
display: flex;
flex-direction: column;
align-items: center;
gap: 40px;
min-width: max-content;
}

.org-level {
display: flex;
justify-content: center;
gap: 60px;
position: relative;
flex-wrap: wrap;
}

.org-node {
background: var(--surface);
border: 2px solid var(--border-strong);
border-radius: var(--radius-md);
padding: 16px 20px;
min-width: 180px;
max-width: 220px;
text-align: center;
position: relative;
transition: all .2s ease;
cursor: pointer;
}

.org-node:hover {
border-color: var(--accent-primary);
transform: translateY(-2px);
box-shadow: var(--shadow-md);
}

.org-node.has-photo {
padding-top: 60px;
}

.org-node-photo {
width: 60px;
height: 60px;
border-radius: 50%;
background: linear-gradient(135deg, var(--accent-primary), var(--accent-tertiary));
position: absolute;
top: -30px;
left: 50%;
transform: translateX(-50%);
border: 3px solid var(--surface);
display: flex;
align-items: center;
justify-content: center;
color: white;
font-weight: 700;
font-size: 1.25rem;
}

.org-node-name {
font-weight: 700;
font-size: 1rem;
margin-bottom: 4px;
color: var(--text-primary);
}

.org-node-role {
font-size: 0.8125rem;
color: var(--text-secondary);
margin-bottom: 8px;
}

.org-node-dept {
font-size: 0.75rem;
color: var(--text-muted);
padding: 4px 8px;
background: rgba(255,255,255,.05);
border-radius: 4px;
display: inline-block;
}

.org-node-connector {
position: absolute;
width: 2px;
height: 40px;
background: var(--border-strong);
top: 100%;
left: 50%;
transform: translateX(-50%);
}

.org-node-connector-h {
position: absolute;
height: 2px;
background: var(--border-strong);
top: -40px;
left: 50%;
}

.org-department-group {
display: flex;
flex-direction: column;
align-items: center;
gap: 20px;
margin: 0 20px;
}

.org-department-label {
font-size: 0.75rem;
font-weight: 600;
color: var(--text-muted);
text-transform: uppercase;
letter-spacing: 0.05em;
padding: 6px 12px;
background: rgba(255,255,255,.05);
border-radius: 999px;
border: 1px solid var(--border);
}

.org-department-members {
display: flex;
gap: 20px;
flex-wrap: wrap;
justify-content: center;
}

/* Draggable org chart builder */
.org-builder-controls {
display: flex;
gap: 12px;
margin-bottom: 20px;
flex-wrap: wrap;
}

.org-node-template {
padding: 12px 16px;
border: 2px dashed var(--border-strong);
border-radius: var(--radius-md);
background: var(--bg-tertiary);
cursor: grab;
transition: all .2s ease;
}

.org-node-template:hover {
border-color: var(--accent-primary);
background: var(--surface);
}

.org-node-template:active {
cursor: grabbing;
}

/* Stakeholder Register Table */
.register-table-container {
overflow-x: auto;
background: white;
border-radius: var(--radius-lg);
padding: 24px;
box-shadow: var(--shadow-md);
}

.register-header {
margin-bottom: 20px;
}

.register-title {
font-size: 1.5rem;
font-weight: 700;
color: #1f2937;
margin-bottom: 8px;
}

.register-title .highlight {
color: #f59e0b;
}

.register-subtitle {
font-size: 0.875rem;
color: #6b7280;
font-style: italic;
line-height: 1.5;
}

.register-table {
width: 100%;
border-collapse: collapse;
font-size: 0.875rem;
margin-top: 20px;
}

.register-table thead {
background: #f9fafb;
border-bottom: 2px solid #e5e7eb;
}

.register-table th {
padding: 12px 16px;
text-align: left;
font-weight: 700;
color: #374151;
text-transform: uppercase;
font-size: 0.75rem;
letter-spacing: 0.05em;
border-bottom: 2px solid #d1d5db;
}

.register-table tbody tr {
border-bottom: 1px solid #e5e7eb;
transition: background .15s ease;
}

.register-table tbody tr:hover {
background: #f9fafb;
}

.register-table tbody tr.highlight-row {
background: #fef3c7;
}

.register-table td {
padding: 14px 16px;
color: #1f2937;
vertical-align: top;
}

.register-table td:first-child {
font-weight: 600;
}

.register-role {
color: #6b7280;
font-size: 0.8125rem;
}

.register-responsibility {
color: #4b5563;
line-height: 1.5;
}

.register-score {
text-align: center;
font-weight: 700;
color: #1f2937;
font-size: 1rem;
}
</style>
</head>
<body>

<div class="container">
  <header class="header">
    <div class="brand">
      <div class="logo">B</div>
      <div class="brand-text">
        <h1>Business Analyst Builder</h1>
        <p>Stakeholder mapping, requirements, and delivery artefacts</p>
      </div>
    </div>
    <nav class="nav">
      <button class="nav-btn active" data-route="home">Home</button>
      <button class="nav-btn" data-route="stakeholders">Stakeholders</button>
      <button class="nav-btn" data-route="orgchart">Org Chart</button>
      <button class="nav-btn" data-route="requirements">Requirements</button>
      <button class="nav-btn" data-route="process">Process</button>
      <button class="nav-btn" data-route="output">Output</button>
      <button class="nav-btn" data-route="library">Library</button>
    </nav>
  </header>

  <main id="app"></main>
</div>

<!-- Modal -->
<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal">
    <div class="modal-header">
      <div>
        <h3 class="modal-title" id="modalTitle">Modal Title</h3>
        <p class="text-muted text-sm" id="modalSubtitle"></p>
      </div>
      <button class="modal-close" id="modalClose">√ó</button>
    </div>
    <div class="modal-body" id="modalBody"></div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
/* ============================================
   DATA & STATE
   ============================================ */
const APP_KEY = "BAB_V3_STATE";

const DEFAULT_STATE = {
  route: "home",
  project: {
    name: "",
    description: ""
  },
  stakeholders: [],
  requirements: {
    problem: "",
    goal: "",
    inScope: "",
    outScope: "",
    success: "",
    constraints: "",
    assumptions: "",
    risks: ""
  },
  process: {
    asIs: "",
    toBe: "",
    decisions: "",
    exceptions: ""
  }
};

let state = loadState();

function loadState() {
  try {
    const saved = localStorage.getItem(APP_KEY);
    if (!saved) return structuredClone(DEFAULT_STATE);
    return { ...structuredClone(DEFAULT_STATE), ...JSON.parse(saved) };
  } catch {
    return structuredClone(DEFAULT_STATE);
  }
}

function saveState() {
  try {
    localStorage.setItem(APP_KEY, JSON.stringify(state));
  } catch {}
}

/* ============================================
   STAKEHOLDER DATA STRUCTURE
   ============================================ */
const ENGAGEMENT_LEVELS = [
  { id: "unaware", label: "Unaware", color: "danger" },
  { id: "resistant", label: "Resistant", color: "warning" },
  { id: "neutral", label: "Neutral", color: "muted" },
  { id: "supportive", label: "Supportive", color: "success" },
  { id: "leading", label: "Leading", color: "primary" }
];

const STAKEHOLDER_CATEGORIES = [
  { id: "customer_facing", label: "Customer Facing", color: "#22d3ee", icon: "üë•" },
  { id: "operations", label: "Operations", color: "#10b981", icon: "‚öôÔ∏è" },
  { id: "marketing", label: "Marketing", color: "#a78bfa", icon: "üì¢" },
  { id: "engineering", label: "Engineering", color: "#6366f1", icon: "üíª" },
  { id: "finance", label: "Finance", color: "#f59e0b", icon: "üí∞" },
  { id: "leadership", label: "Leadership", color: "#ef4444", icon: "üéØ" },
  { id: "support", label: "Support", color: "#8b5cf6", icon: "üõü" },
  { id: "other", label: "Other", color: "#64748b", icon: "üìã" }
];

function createStakeholder() {
  return {
    id: Date.now().toString(36) + Math.random().toString(36).substr(2),
    name: "",
    role: "",
    department: "",
    category: "other", // customer_facing, operations, marketing, etc.
    influence: 50, // 0-100
    impact: 50,    // 0-100
    engagement: "neutral",
    notes: "",
    contact: "",
    hierarchyLevel: 0, // 0 = top level (exec), 1 = managers, 2 = team members
    reportsTo: null // ID of manager/supervisor
  };
}

/* ============================================
   UTILITIES
   ============================================ */
function escapeHtml(str) {
  return String(str ?? "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#39;");
}

function toast(msg) {
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.style.display = "block";
  clearTimeout(toast._timer);
  toast._timer = setTimeout(() => {
    t.style.display = "none";
  }, 2000);
}

function openModal(title, subtitle, body) {
  document.getElementById("modalTitle").textContent = title;
  document.getElementById("modalSubtitle").textContent = subtitle || "";
  document.getElementById("modalBody").innerHTML = body;
  document.getElementById("modalBackdrop").style.display = "flex";
}

function closeModal() {
  document.getElementById("modalBackdrop").style.display = "none";
}

document.getElementById("modalClose").addEventListener("click", closeModal);
document.getElementById("modalBackdrop").addEventListener("click", (e) => {
  if (e.target.id === "modalBackdrop") closeModal();
});

/* ============================================
   ROUTING
   ============================================ */
function setRoute(route) {
  state.route = route;
  saveState();
  render();
}

document.addEventListener("click", (e) => {
  const btn = e.target.closest("[data-route]");
  if (btn) {
    setRoute(btn.dataset.route);
  }
});

/* ============================================
   VIEWS
   ============================================ */
function viewHome() {
  return `
    <div class="grid grid-2">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Welcome to BAB</h2>
          <p class="card-subtitle">Your complete Business Analyst toolkit for stakeholder engagement, requirements gathering, and delivery support.</p>
        </div>
        <div class="card-body">
          <div class="form-group">
            <label>Project Name</label>
            <input type="text" class="input" id="projectName" placeholder="e.g., NOC Escalation Redesign" value="${escapeHtml(state.project.name)}" />
          </div>
          <div class="form-group">
            <label>Project Description</label>
            <textarea class="input" id="projectDesc" placeholder="Brief overview of the initiative...">${escapeHtml(state.project.description)}</textarea>
          </div>
          <div class="btn-group">
            <button class="btn btn-primary" data-route="stakeholders">Start with Stakeholders ‚Üí</button>
            <button class="btn" data-route="requirements">Jump to Requirements</button>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Quick Start Guide</h3>
          <p class="card-subtitle">Follow the BA workflow</p>
        </div>
        <div class="card-body">
          <div class="grid gap-4">
            ${[
              { icon: "üë•", title: "Stakeholder Management", desc: "Map influence, impact, and engagement levels", route: "stakeholders" },
              { icon: "üìä", title: "Org Chart", desc: "Visual organizational breakdown structure", route: "orgchart" },
              { icon: "üìã", title: "Requirements Gathering", desc: "Problem, goals, scope, and success criteria", route: "requirements" },
              { icon: "üîÑ", title: "Process Mapping", desc: "AS-IS and TO-BE with decision points", route: "process" },
              { icon: "üìÑ", title: "Generate Output", desc: "Copy-ready documentation", route: "output" }
            ].map(item => `
              <div class="mini-card" data-route="${item.route}">
                <h4>${item.icon} ${item.title}</h4>
                <p>${item.desc}</p>
              </div>
            `).join("")}
          </div>
        </div>
      </div>
    </div>
  `;
}

function viewStakeholders() {
  const stakeholders = state.stakeholders || [];
  
  return `
    <div class="card">
      <div class="card-header">
        <div class="flex justify-between items-center">
          <div>
            <h2 class="card-title">Stakeholder Management</h2>
            <p class="card-subtitle">Identify, map, and track stakeholder engagement</p>
          </div>
          <div class="flex gap-2">
            <button class="btn btn-primary" id="addStakeholder">+ Add Stakeholder</button>
            <button class="btn" id="viewRegister">Stakeholder Register</button>
            <button class="btn" id="viewMapFromStakeholders">Stakeholder Map</button>
          </div>
        </div>
      </div>
    </div>

    <div class="grid grid-3">
      <!-- Stakeholder Register -->
      <div class="card" style="grid-column: span 2;">
        <div class="card-header">
          <h3 class="card-title">Stakeholder Register</h3>
          <p class="card-subtitle">${stakeholders.length} stakeholder${stakeholders.length !== 1 ? 's' : ''} identified</p>
        </div>
        <div class="card-body">
          ${stakeholders.length === 0 ? `
            <div class="empty-state">
              <h3>No stakeholders yet</h3>
              <p>Click "Add Stakeholder" to start building your stakeholder register</p>
            </div>
          ` : `
            <div class="stakeholder-grid">
              ${stakeholders.map(s => renderStakeholderCard(s)).join("")}
            </div>
          `}
        </div>
      </div>

      <!-- Quick Stats -->
      <div>
        <div class="card mb-4">
          <div class="card-header">
            <h3 class="card-title">Engagement Overview</h3>
          </div>
          <div class="card-body">
            ${ENGAGEMENT_LEVELS.map(level => {
              const count = stakeholders.filter(s => s.engagement === level.id).length;
              const pct = stakeholders.length > 0 ? Math.round((count / stakeholders.length) * 100) : 0;
              return `
                <div class="flex justify-between items-center mb-4">
                  <span class="text-sm">${level.label}</span>
                  <span class="badge badge-${level.color}">${count} (${pct}%)</span>
                </div>
              `;
            }).join("")}
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Quick Actions</h3>
          </div>
          <div class="card-body">
            <button class="btn btn-sm" style="width: 100%; margin-bottom: 8px;" id="exportStakeholders">Export Register</button>
            <button class="btn btn-sm" style="width: 100%;" data-route="requirements">Continue to Requirements ‚Üí</button>
          </div>
        </div>
      </div>
    </div>
  `;
}

function renderStakeholderCard(s) {
  const engagementLevel = ENGAGEMENT_LEVELS.find(e => e.id === s.engagement) || ENGAGEMENT_LEVELS[2];
  const influenceLevel = s.influence >= 70 ? "High" : s.influence >= 40 ? "Medium" : "Low";
  const impactLevel = s.impact >= 70 ? "High" : s.impact >= 40 ? "Medium" : "Low";
  const category = STAKEHOLDER_CATEGORIES.find(c => c.id === (s.category || 'other'));
  
  return `
    <div class="stakeholder-card" style="border-left: 3px solid ${category ? category.color : '#64748b'};">
      <div class="stakeholder-header">
        <div>
          <div class="stakeholder-name">${escapeHtml(s.name) || "Unnamed"}</div>
          <div class="stakeholder-role">${escapeHtml(s.role)}</div>
          ${s.department ? `<div class="text-muted text-sm">${escapeHtml(s.department)}</div>` : ""}
        </div>
        <div class="flex gap-2">
          <button class="btn btn-sm" data-edit-stakeholder="${s.id}">Edit</button>
          <button class="btn btn-sm btn-danger" data-delete-stakeholder="${s.id}">√ó</button>
        </div>
      </div>
      
      <div class="stakeholder-meta">
        ${category ? `<span class="badge" style="background: ${category.color}22; border-color: ${category.color}44; color: ${category.color};">${category.icon} ${category.label}</span>` : ''}
        <span class="badge">Influence: ${influenceLevel}</span>
        <span class="badge">Impact: ${impactLevel}</span>
        <span class="badge badge-${engagementLevel.color}">${engagementLevel.label}</span>
      </div>

      ${s.notes ? `<div class="text-sm text-muted mt-4">${escapeHtml(s.notes)}</div>` : ""}
    </div>
  `;
}

function viewOrgChart() {
  const stakeholders = state.stakeholders || [];
  
  // Organize by hierarchy level and category
  const byLevel = {};
  const byCategory = {};
  
  stakeholders.forEach(s => {
    const level = s.hierarchyLevel || 0;
    if (!byLevel[level]) byLevel[level] = [];
    byLevel[level].push(s);
    
    const cat = s.category || "other";
    if (!byCategory[cat]) byCategory[cat] = [];
    byCategory[cat].push(s);
  });
  
  return `
    <div class="card">
      <div class="card-header">
        <div class="flex justify-between items-center">
          <div>
            <h2 class="card-title">Organizational Breakdown Structure</h2>
            <p class="card-subtitle">Visual hierarchy organized by functional categories</p>
          </div>
          <div class="flex gap-2">
            <button class="btn btn-primary" id="viewStakeholderMap">Stakeholder Map</button>
            <button class="btn" id="toggleOrgView">By Hierarchy</button>
            <button class="btn" id="toggleCategoryView">By Category</button>
            <button class="btn" id="exportOrgChart">Export Chart</button>
          </div>
        </div>
      </div>
      <div class="card-body">
        ${stakeholders.length === 0 ? `
          <div class="empty-state">
            <h3>No stakeholders to display</h3>
            <p>Add stakeholders with hierarchy and category information to see the organizational chart</p>
            <button class="btn btn-primary" data-route="stakeholders">Add Stakeholders</button>
          </div>
        ` : `
          <!-- Hierarchy View -->
          <div id="hierarchyView">
            <div class="org-chart-container">
              ${renderOrgChartByHierarchy(byLevel)}
            </div>
          </div>
          
          <!-- Category View -->
          <div id="categoryView" style="display: none;">
            <div class="org-chart-container">
              ${renderOrgChartByCategory(byCategory, stakeholders)}
            </div>
          </div>
          
          <div style="margin-top: 40px;">
            <h3 style="margin-bottom: 16px;">Category Breakdown</h3>
            <div class="grid grid-4">
              ${STAKEHOLDER_CATEGORIES.map(cat => {
                const members = byCategory[cat.id] || [];
                if (members.length === 0) return '';
                
                return `
                  <div class="card" style="background: var(--bg-tertiary); border-left: 3px solid ${cat.color};">
                    <div class="card-header" style="padding: 12px 16px;">
                      <h4 style="font-size: 1rem; display: flex; align-items: center; gap: 8px;">
                        <span>${cat.icon}</span>
                        <span>${cat.label}</span>
                      </h4>
                      <p class="text-muted text-sm">${members.length} member${members.length !== 1 ? 's' : ''}</p>
                    </div>
                    <div class="card-body" style="padding: 12px 16px;">
                      ${members.slice(0, 5).map(m => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border);">
                          <div>
                            <div style="font-weight: 600; font-size: 0.875rem;">${escapeHtml(m.name)}</div>
                            <div class="text-muted text-sm">${escapeHtml(m.role)}</div>
                          </div>
                          <span class="badge badge-${getEngagementColor(m.engagement)}" style="font-size: 0.65rem; padding: 3px 6px;">${getEngagementLabel(m.engagement)}</span>
                        </div>
                      `).join("")}
                      ${members.length > 5 ? `<div class="text-muted text-sm" style="margin-top: 8px; text-align: center;">+${members.length - 5} more</div>` : ''}
                    </div>
                  </div>
                `;
              }).filter(Boolean).join("")}
            </div>
          </div>
        `}
      </div>
    </div>
  `;
}

function renderOrgChartByHierarchy(byLevel) {
  const levels = Object.keys(byLevel).sort((a, b) => parseInt(a) - parseInt(b));
  
  if (levels.length === 0) {
    return '<div class="empty-state"><p>No hierarchy data available</p></div>';
  }
  
  return `
    <div class="org-chart">
      ${levels.map(levelNum => {
        const members = byLevel[levelNum];
        const levelLabel = levelNum === '0' ? 'Leadership' : levelNum === '1' ? 'Management' : levelNum === '2' ? 'Team Members' : `Level ${levelNum}`;
        
        return `
          <div style="width: 100%;">
            <div class="org-department-label" style="margin: 0 auto 20px; width: fit-content;">
              ${levelLabel}
            </div>
            <div class="org-level">
              ${members.map(s => renderOrgNode(s)).join("")}
            </div>
          </div>
        `;
      }).join("")}
    </div>
  `;
}

function renderOrgChartByCategory(byCategory, allStakeholders) {
  const categories = STAKEHOLDER_CATEGORIES.filter(cat => byCategory[cat.id] && byCategory[cat.id].length > 0);
  
  if (categories.length === 0) {
    return '<div class="empty-state"><p>No category data available</p></div>';
  }
  
  return `
    <div class="org-chart">
      ${categories.map(cat => {
        const members = byCategory[cat.id];
        
        return `
          <div style="width: 100%; margin-bottom: 40px;">
            <div style="margin: 0 auto 20px; width: fit-content; display: flex; align-items: center; gap: 12px; padding: 10px 20px; background: var(--surface); border-radius: 999px; border: 2px solid ${cat.color};">
              <span style="font-size: 1.5rem;">${cat.icon}</span>
              <span style="font-weight: 700; font-size: 1rem;">${cat.label}</span>
              <span class="badge" style="background: ${cat.color}; color: white; border-color: ${cat.color};">${members.length}</span>
            </div>
            <div class="org-level">
              ${members.map(s => renderOrgNode(s, cat.color)).join("")}
            </div>
          </div>
        `;
      }).join("")}
    </div>
  `;
}

function renderOrgNode(s, accentColor = null) {
  const initials = s.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2) || '??';
  
  // Get category color if not provided
  if (!accentColor) {
    const cat = STAKEHOLDER_CATEGORIES.find(c => c.id === (s.category || 'other'));
    accentColor = cat ? cat.color : '#6366f1';
  }
  
  const categoryInfo = STAKEHOLDER_CATEGORIES.find(c => c.id === (s.category || 'other'));
  
  return `
    <div class="org-node has-photo" data-stakeholder-id="${s.id}">
      <div class="org-node-photo" style="background: ${accentColor};">
        ${initials}
      </div>
      <div class="org-node-name">${escapeHtml(s.name) || 'Unnamed'}</div>
      <div class="org-node-role">${escapeHtml(s.role) || 'No role'}</div>
      ${categoryInfo ? `<div class="org-node-dept" style="background: ${accentColor}22; color: ${accentColor}; border: 1px solid ${accentColor}44;">${categoryInfo.icon} ${categoryInfo.label}</div>` : ''}
    </div>
  `;
}

function getEngagementLabel(engagementId) {
  const level = ENGAGEMENT_LEVELS.find(e => e.id === engagementId);
  return level ? level.label : 'Neutral';
}

function getEngagementColor(engagementId) {
  const level = ENGAGEMENT_LEVELS.find(e => e.id === engagementId);
  return level ? level.color : 'muted';
}

function viewRequirements() {
  const r = state.requirements;
  
  return `
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">Requirements Gathering</h2>
        <p class="card-subtitle">Define the problem, goal, scope, and success criteria</p>
      </div>
      <div class="card-body">
        <div class="grid grid-2">
          <div class="form-group">
            <label>Problem Statement</label>
            <textarea class="input" id="reqProblem" placeholder="What's the observable problem today?">${escapeHtml(r.problem)}</textarea>
            <div class="input-hint">Focus on observable facts, not solutions</div>
          </div>

          <div class="form-group">
            <label>Goal / Outcome</label>
            <textarea class="input" id="reqGoal" placeholder="What measurable outcome do we want?">${escapeHtml(r.goal)}</textarea>
            <div class="input-hint">Make it specific and measurable</div>
          </div>

          <div class="form-group">
            <label>In Scope</label>
            <textarea class="input" id="reqInScope" placeholder="What IS included in this work?">${escapeHtml(r.inScope)}</textarea>
            <div class="input-hint">One item per line</div>
          </div>

          <div class="form-group">
            <label>Out of Scope</label>
            <textarea class="input" id="reqOutScope" placeholder="What is NOT included?">${escapeHtml(r.outScope)}</textarea>
            <div class="input-hint">Prevents scope creep</div>
          </div>

          <div class="form-group">
            <label>Success Measures</label>
            <textarea class="input" id="reqSuccess" placeholder="How will we measure success?">${escapeHtml(r.success)}</textarea>
            <div class="input-hint">Leading and lagging indicators</div>
          </div>

          <div class="form-group">
            <label>Constraints</label>
            <textarea class="input" id="reqConstraints" placeholder="Tech, time, budget, policy limitations...">${escapeHtml(r.constraints)}</textarea>
            <div class="input-hint">Non-negotiable boundaries</div>
          </div>

          <div class="form-group">
            <label>Assumptions</label>
            <textarea class="input" id="reqAssumptions" placeholder="What are we assuming to be true?">${escapeHtml(r.assumptions)}</textarea>
            <div class="input-hint">Validate these early</div>
          </div>

          <div class="form-group">
            <label>Risks & Dependencies</label>
            <textarea class="input" id="reqRisks" placeholder="What could block us?">${escapeHtml(r.risks)}</textarea>
            <div class="input-hint">Include owners and mitigation</div>
          </div>
        </div>

        <div class="btn-group">
          <button class="btn btn-primary" data-route="process">Continue to Process Mapping ‚Üí</button>
          <button class="btn" data-route="stakeholders">‚Üê Back to Stakeholders</button>
        </div>
      </div>
    </div>
  `;
}

function viewProcess() {
  const p = state.process;
  
  return `
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">Process Mapping</h2>
        <p class="card-subtitle">Document current and future state processes</p>
      </div>
      <div class="card-body">
        <div class="grid grid-2">
          <div class="form-group">
            <label>AS-IS (Current State)</label>
            <textarea class="input" id="procAsIs" style="min-height: 200px;" placeholder="1. Current step one
2. Current step two
...">${escapeHtml(p.asIs)}</textarea>
            <div class="input-hint">Document how it works today, including pain points</div>
          </div>

          <div class="form-group">
            <label>TO-BE (Future State)</label>
            <textarea class="input" id="procToBe" style="min-height: 200px;" placeholder="1. Improved step one
2. Improved step two
...">${escapeHtml(p.toBe)}</textarea>
            <div class="input-hint">How will it work after changes?</div>
          </div>

          <div class="form-group">
            <label>Decision Points</label>
            <textarea class="input" id="procDecisions" placeholder="Key decision rules and thresholds...">${escapeHtml(p.decisions)}</textarea>
            <div class="input-hint">IF/THEN logic, thresholds, escalation rules</div>
          </div>

          <div class="form-group">
            <label>Exceptions & Edge Cases</label>
            <textarea class="input" id="procExceptions" placeholder="What happens when things go wrong?">${escapeHtml(p.exceptions)}</textarea>
            <div class="input-hint">Document known exceptions early</div>
          </div>
        </div>

        <div class="btn-group">
          <button class="btn btn-primary" data-route="output">Generate Output ‚Üí</button>
          <button class="btn" data-route="requirements">‚Üê Back to Requirements</button>
        </div>
      </div>
    </div>
  `;
}

function viewOutput() {
  const output = generateOutput();
  
  return `
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">Generated Output</h2>
        <p class="card-subtitle">Copy-ready documentation for meetings and handover</p>
      </div>
      <div class="card-body">
        <div class="output-container">
          <div class="output-header">
            <div class="flex gap-2">
              <span class="badge badge-primary">Ready to copy</span>
              <span class="badge">${output.split('\n').length} lines</span>
            </div>
            <div class="flex gap-2">
              <button class="btn btn-sm" id="copyOutput">Copy All</button>
              <button class="btn btn-sm" id="downloadOutput">Download .txt</button>
            </div>
          </div>
          <div class="output-body">${escapeHtml(output)}</div>
        </div>

        <div class="btn-group">
          <button class="btn" id="exportProject">Export Project (JSON)</button>
          <button class="btn" id="importProject">Import Project</button>
          <input type="file" id="importFile" accept=".json" style="display: none;" />
        </div>
      </div>
    </div>
  `;
}

function viewLibrary() {
  return `
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">BA Library</h2>
        <p class="card-subtitle">Templates, examples, and reference materials</p>
      </div>
      <div class="card-body">
        <div class="grid grid-3">
          ${[
            { title: "Stakeholder Analysis", desc: "How to map influence and engagement" },
            { title: "Requirements Templates", desc: "User stories, acceptance criteria, NFRs" },
            { title: "Process Mapping", desc: "AS-IS/TO-BE documentation patterns" },
            { title: "Meeting Prep", desc: "Discovery, validation, and decision sessions" },
            { title: "UAT Planning", desc: "Test scenarios and sign-off criteria" },
            { title: "Common Mistakes", desc: "Anti-patterns to avoid" }
          ].map(item => `
            <div class="mini-card">
              <h4>${item.title}</h4>
              <p>${item.desc}</p>
            </div>
          `).join("")}
        </div>
      </div>
    </div>
  `;
}

/* ============================================
   OUTPUT GENERATION
   ============================================ */
function generateOutput() {
  const lines = [];
  
  lines.push("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
  lines.push("BUSINESS ANALYST DOCUMENTATION");
  lines.push("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
  lines.push("");
  
  if (state.project.name) {
    lines.push(`Project: ${state.project.name}`);
    if (state.project.description) {
      lines.push(`Description: ${state.project.description}`);
    }
    lines.push("");
  }

  // Stakeholders
  if (state.stakeholders && state.stakeholders.length > 0) {
    lines.push("STAKEHOLDER REGISTER");
    lines.push("‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ");
    state.stakeholders.forEach(s => {
      lines.push(`‚Ä¢ ${s.name || "Unnamed"} (${s.role || "No role"})`);
      if (s.department) lines.push(`  Department: ${s.department}`);
      lines.push(`  Influence: ${s.influence >= 70 ? "High" : s.influence >= 40 ? "Medium" : "Low"}`);
      lines.push(`  Impact: ${s.impact >= 70 ? "High" : s.impact >= 40 ? "Medium" : "Low"}`);
      const eng = ENGAGEMENT_LEVELS.find(e => e.id === s.engagement);
      lines.push(`  Engagement: ${eng ? eng.label : "Neutral"}`);
      if (s.notes) lines.push(`  Notes: ${s.notes}`);
      lines.push("");
    });
  }

  // Requirements
  const r = state.requirements;
  if (r.problem || r.goal) {
    lines.push("REQUIREMENTS");
    lines.push("‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ");
    if (r.problem) {
      lines.push("Problem Statement:");
      lines.push(r.problem);
      lines.push("");
    }
    if (r.goal) {
      lines.push("Goal / Outcome:");
      lines.push(r.goal);
      lines.push("");
    }
    if (r.inScope) {
      lines.push("In Scope:");
      r.inScope.split('\n').filter(Boolean).forEach(line => lines.push(`  ‚Ä¢ ${line}`));
      lines.push("");
    }
    if (r.outScope) {
      lines.push("Out of Scope:");
      r.outScope.split('\n').filter(Boolean).forEach(line => lines.push(`  ‚Ä¢ ${line}`));
      lines.push("");
    }
    if (r.success) {
      lines.push("Success Measures:");
      r.success.split('\n').filter(Boolean).forEach(line => lines.push(`  ‚Ä¢ ${line}`));
      lines.push("");
    }
    if (r.constraints) {
      lines.push("Constraints:");
      r.constraints.split('\n').filter(Boolean).forEach(line => lines.push(`  ‚Ä¢ ${line}`));
      lines.push("");
    }
    if (r.assumptions) {
      lines.push("Assumptions:");
      r.assumptions.split('\n').filter(Boolean).forEach(line => lines.push(`  ‚Ä¢ ${line}`));
      lines.push("");
    }
    if (r.risks) {
      lines.push("Risks & Dependencies:");
      r.risks.split('\n').filter(Boolean).forEach(line => lines.push(`  ‚Ä¢ ${line}`));
      lines.push("");
    }
  }

  // Process
  const p = state.process;
  if (p.asIs || p.toBe) {
    lines.push("PROCESS MAPPING");
    lines.push("‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ");
    if (p.asIs) {
      lines.push("AS-IS (Current State):");
      lines.push(p.asIs);
      lines.push("");
    }
    if (p.toBe) {
      lines.push("TO-BE (Future State):");
      lines.push(p.toBe);
      lines.push("");
    }
    if (p.decisions) {
      lines.push("Decision Points:");
      lines.push(p.decisions);
      lines.push("");
    }
    if (p.exceptions) {
      lines.push("Exceptions & Edge Cases:");
      lines.push(p.exceptions);
      lines.push("");
    }
  }

  lines.push("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
  lines.push(`Generated: ${new Date().toLocaleString()}`);
  lines.push("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");

  return lines.join('\n');
}

/* ============================================
   STAKEHOLDER MODAL
   ============================================ */
function openStakeholderModal(stakeholder = null) {
  const isEdit = !!stakeholder;
  const s = stakeholder || createStakeholder();
  const allStakeholders = state.stakeholders || [];
  const potentialManagers = allStakeholders.filter(sh => sh.id !== s.id && (sh.hierarchyLevel || 0) < (s.hierarchyLevel || 0));
  
  const body = `
    <div class="form-group">
      <label>Name *</label>
      <input type="text" class="input" id="modalStakeholderName" value="${escapeHtml(s.name)}" placeholder="Full name" />
    </div>
    
    <div class="grid grid-2">
      <div class="form-group">
        <label>Role / Title *</label>
        <input type="text" class="input" id="modalStakeholderRole" value="${escapeHtml(s.role)}" placeholder="e.g., Product Owner" />
      </div>
      <div class="form-group">
        <label>Department</label>
        <input type="text" class="input" id="modalStakeholderDept" value="${escapeHtml(s.department)}" placeholder="e.g., Engineering" />
      </div>
    </div>

    <div class="grid grid-2">
      <div class="form-group">
        <label>Functional Category *</label>
        <select class="input" id="modalStakeholderCategory">
          ${STAKEHOLDER_CATEGORIES.map(cat => `
            <option value="${cat.id}" ${(s.category || 'other') === cat.id ? 'selected' : ''}>
              ${cat.icon} ${cat.label}
            </option>
          `).join("")}
        </select>
        <div class="input-hint">Primary functional area</div>
      </div>
      <div class="form-group">
        <label>Contact</label>
        <input type="text" class="input" id="modalStakeholderContact" value="${escapeHtml(s.contact)}" placeholder="Email or phone" />
      </div>
    </div>

    <div class="grid grid-2">
      <div class="form-group">
        <label>Hierarchy Level</label>
        <select class="input" id="modalStakeholderHierarchy">
          <option value="0" ${(s.hierarchyLevel || 0) === 0 ? 'selected' : ''}>Leadership (Level 0)</option>
          <option value="1" ${(s.hierarchyLevel || 0) === 1 ? 'selected' : ''}>Management (Level 1)</option>
          <option value="2" ${(s.hierarchyLevel || 0) === 2 ? 'selected' : ''}>Team Member (Level 2)</option>
          <option value="3" ${(s.hierarchyLevel || 0) === 3 ? 'selected' : ''}>Support/Other (Level 3)</option>
        </select>
        <div class="input-hint">Position in organizational hierarchy</div>
      </div>
      <div class="form-group">
        <label>Reports To</label>
        <select class="input" id="modalStakeholderReportsTo">
          <option value="">None (Top Level)</option>
          ${potentialManagers.map(mgr => `
            <option value="${mgr.id}" ${s.reportsTo === mgr.id ? 'selected' : ''}>
              ${escapeHtml(mgr.name)} (${escapeHtml(mgr.role)})
            </option>
          `).join("")}
        </select>
        <div class="input-hint">Manager or supervisor</div>
      </div>
    </div>

    <div class="grid grid-2">
      <div class="form-group">
        <label>Influence (${s.influence}%)</label>
        <input type="range" class="input" id="modalStakeholderInfluence" min="0" max="100" value="${s.influence}" style="padding: 0; height: 40px;" />
        <div class="input-hint">Power to approve/block decisions</div>
      </div>
      <div class="form-group">
        <label>Impact (${s.impact}%)</label>
        <input type="range" class="input" id="modalStakeholderImpact" min="0" max="100" value="${s.impact}" style="padding: 0; height: 40px;" />
        <div class="input-hint">Affected by the outcome</div>
      </div>
    </div>

    <div class="form-group">
      <label>Engagement Level</label>
      <div class="engagement-track">
        <div class="engagement-segments">
          ${ENGAGEMENT_LEVELS.map(level => `
            <div class="engagement-segment ${s.engagement === level.id ? 'active' : ''} engagement-${level.id}" data-engagement="${level.id}">
              ${level.label}
            </div>
          `).join("")}
        </div>
      </div>
    </div>

    <div class="form-group">
      <label>Notes</label>
      <textarea class="input" id="modalStakeholderNotes" placeholder="Key concerns, interests, communication preferences...">${escapeHtml(s.notes)}</textarea>
    </div>

    <div class="btn-group">
      <button class="btn btn-primary" id="saveStakeholder">${isEdit ? 'Update' : 'Add'} Stakeholder</button>
      <button class="btn" onclick="closeModal()">Cancel</button>
    </div>
  `;

  openModal(
    isEdit ? "Edit Stakeholder" : "Add Stakeholder",
    isEdit ? "Update stakeholder details" : "Add a new stakeholder to your register",
    body
  );

  // Wire up engagement segments
  document.querySelectorAll(".engagement-segment").forEach(seg => {
    seg.addEventListener("click", () => {
      document.querySelectorAll(".engagement-segment").forEach(s => s.classList.remove("active"));
      seg.classList.add("active");
    });
  });

  // Wire up range inputs to update labels
  const influenceInput = document.getElementById("modalStakeholderInfluence");
  const impactInput = document.getElementById("modalStakeholderImpact");
  
  influenceInput.addEventListener("input", () => {
    influenceInput.previousElementSibling.textContent = `Influence (${influenceInput.value}%)`;
  });
  
  impactInput.addEventListener("input", () => {
    impactInput.previousElementSibling.textContent = `Impact (${impactInput.value}%)`;
  });

  // Save handler
  document.getElementById("saveStakeholder").addEventListener("click", () => {
    const name = document.getElementById("modalStakeholderName").value.trim();
    const role = document.getElementById("modalStakeholderRole").value.trim();
    
    if (!name || !role) {
      toast("Name and Role are required");
      return;
    }

    const activeEngagement = document.querySelector(".engagement-segment.active");
    
    s.name = name;
    s.role = role;
    s.department = document.getElementById("modalStakeholderDept").value.trim();
    s.category = document.getElementById("modalStakeholderCategory").value;
    s.contact = document.getElementById("modalStakeholderContact").value.trim();
    s.influence = parseInt(influenceInput.value);
    s.impact = parseInt(impactInput.value);
    s.engagement = activeEngagement ? activeEngagement.dataset.engagement : "neutral";
    s.notes = document.getElementById("modalStakeholderNotes").value.trim();
    s.hierarchyLevel = parseInt(document.getElementById("modalStakeholderHierarchy").value);
    s.reportsTo = document.getElementById("modalStakeholderReportsTo").value || null;

    if (!isEdit) {
      if (!state.stakeholders) state.stakeholders = [];
      state.stakeholders.push(s);
    } else {
      const idx = state.stakeholders.findIndex(sh => sh.id === s.id);
      if (idx !== -1) state.stakeholders[idx] = s;
    }

    saveState();
    closeModal();
    render();
    toast(isEdit ? "Stakeholder updated" : "Stakeholder added");
  });
}

function openStakeholderRegister() {
  const stakeholders = state.stakeholders || [];
  
  if (stakeholders.length === 0) {
    toast("Add stakeholders first to generate the register");
    return;
  }
  
  const body = `
    <div class="register-table-container">
      <div class="register-header">
        <h2 class="register-title">STAKEHOLDER <span class="highlight">REGISTER</span></h2>
        <p class="register-subtitle">
          Below are the stakeholders involved in the project, including their role, responsibility and classification.<br/>
          New stakeholders will be added to this document as they are identified.
        </p>
      </div>
      
      <table class="register-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Role</th>
            <th>Responsibility</th>
            <th>Stakeholder<br/>Influence</th>
            <th>Project Impact on<br/>Stakeholder</th>
          </tr>
        </thead>
        <tbody>
          ${stakeholders.map((s, idx) => {
            const isHighlighted = idx >= stakeholders.length - 3; // Highlight last 3 as "new" or different
            const responsibility = s.notes || 
              (s.category === 'customer_facing' ? 'Direct customer interaction and service delivery.' :
               s.category === 'operations' ? 'Ensures operations run smoothly and efficiently.' :
               s.category === 'marketing' ? 'Promotes and communicates project value.' :
               s.category === 'engineering' ? 'Builds and maintains technical solutions.' :
               s.category === 'finance' ? 'Manages budget and financial aspects.' :
               s.category === 'leadership' ? 'Provides strategic direction and decision-making.' :
               s.category === 'support' ? 'Provides assistance and resolves issues.' :
               'Contributes to project success.');
            
            return `
              <tr class="${isHighlighted ? 'highlight-row' : ''}">
                <td><strong>${escapeHtml(s.name)}</strong></td>
                <td class="register-role">${escapeHtml(s.role)}</td>
                <td class="register-responsibility">${escapeHtml(responsibility)}</td>
                <td class="register-score">${Math.round(s.influence / 10)}</td>
                <td class="register-score">${Math.round(s.impact / 10)}</td>
              </tr>
            `;
          }).join("")}
        </tbody>
      </table>
      
      <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
        <p style="font-size: 0.75rem; color: #6b7280; margin: 0;">
          <strong>Note:</strong> Influence and Impact are scored on a scale of 1-10. 
          Higher scores indicate greater influence over project decisions or greater impact from project outcomes.
        </p>
      </div>
    </div>
    
    <div class="btn-group" style="margin-top: 20px;">
      <button class="btn btn-primary" id="downloadRegister">Download Register</button>
      <button class="btn" id="copyRegisterTable">Copy Table</button>
    </div>
  `;
  
  openModal("Stakeholder Register", `${stakeholders.length} stakeholders documented`, body);
  
  // Wire download button
  setTimeout(() => {
    document.getElementById("downloadRegister")?.addEventListener("click", () => {
      downloadStakeholderRegister();
    });
    
    document.getElementById("copyRegisterTable")?.addEventListener("click", () => {
      const text = generateRegisterText();
      navigator.clipboard.writeText(text).then(() => {
        toast("Register copied to clipboard");
      }).catch(() => {
        toast("Copy failed - use download instead");
      });
    });
  }, 100);
}

function generateRegisterText() {
  const stakeholders = state.stakeholders || [];
  const lines = [];
  
  lines.push("STAKEHOLDER REGISTER");
  lines.push("=".repeat(80));
  lines.push("");
  lines.push("Below are the stakeholders involved in the project, including their role,");
  lines.push("responsibility and classification.");
  lines.push("");
  lines.push("-".repeat(80));
  
  stakeholders.forEach(s => {
    const responsibility = s.notes || "Contributes to project success.";
    lines.push("");
    lines.push(`Name: ${s.name}`);
    lines.push(`Role: ${s.role}`);
    if (s.department) lines.push(`Department: ${s.department}`);
    const cat = STAKEHOLDER_CATEGORIES.find(c => c.id === s.category);
    if (cat) lines.push(`Category: ${cat.label}`);
    lines.push(`Responsibility: ${responsibility}`);
    lines.push(`Stakeholder Influence: ${Math.round(s.influence / 10)}/10`);
    lines.push(`Project Impact on Stakeholder: ${Math.round(s.impact / 10)}/10`);
    lines.push(`Engagement: ${getEngagementLabel(s.engagement)}`);
    if (s.contact) lines.push(`Contact: ${s.contact}`);
    lines.push("-".repeat(80));
  });
  
  return lines.join("\n");
}

function downloadStakeholderRegister() {
  const text = generateRegisterText();
  const blob = new Blob([text], { type: "text/plain" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `stakeholder-register-${state.project.name || 'project'}.txt`;
  a.click();
  URL.revokeObjectURL(url);
  toast("Register downloaded");
}

function openInfluenceImpactMatrix() {
  const stakeholders = state.stakeholders || [];
  
  const body = `
    <div class="matrix-container">
      <div class="matrix-title">Stakeholder Map</div>
      
      <div class="matrix-labels matrix-label-y">Level of Influence</div>
      
      <div class="matrix-corner-label matrix-corner-tl">Maintain</div>
      <div class="matrix-corner-label matrix-corner-tr">Collaborate With</div>
      <div class="matrix-corner-label matrix-corner-bl">Monitor</div>
      <div class="matrix-corner-label matrix-corner-br">Keep Informed</div>
      
      <div class="matrix-canvas">
        <div class="matrix-grid"></div>
        <div class="matrix-crosshair matrix-crosshair-h"></div>
        <div class="matrix-crosshair matrix-crosshair-v"></div>
        
        ${stakeholders.map((s, idx) => {
          const x = s.impact; // 0-100 (left to right = Impact of Change)
          const y = 100 - s.influence; // 0-100 inverted (bottom to top = Level of Influence)
          const initials = s.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
          
          // Get category color
          const cat = STAKEHOLDER_CATEGORIES.find(c => c.id === (s.category || 'other'));
          const color = cat ? cat.color : '#6366f1';
          
          return `
            <div class="stakeholder-marker" 
                 style="left: ${x}%; top: ${y}%; background: ${color};" 
                 title="${escapeHtml(s.name)} - ${escapeHtml(s.role)}"
                 data-stakeholder-id="${s.id}">
              ${initials}
              <div class="stakeholder-marker-label">${escapeHtml(s.name)}</div>
            </div>
          `;
        }).join("")}
      </div>
      
      <!-- Bottom label outside the matrix -->
      <div style="position: absolute; bottom: 12px; left: 50%; transform: translateX(-50%); font-size: 0.7rem; font-weight: 700; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.05em;">
        Impact of Change
      </div>
    </div>
    
    <div style="margin-top: 40px; background: var(--bg-tertiary); padding: 20px; border-radius: var(--radius-lg);">
      <h4 style="margin-bottom: 16px; font-size: 1rem;">Quadrant Strategy</h4>
      <div class="grid grid-2" style="gap: 16px;">
        <div>
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <div style="width: 16px; height: 16px; background: rgba(16,185,129,.3); border-radius: 4px;"></div>
            <strong style="font-size: 0.875rem;">Collaborate With (Top-Right)</strong>
          </div>
          <p style="font-size: 0.8125rem; color: var(--text-secondary); margin: 0;">High influence, high impact. Engage closely and frequently. Key decision-makers and partners.</p>
        </div>
        
        <div>
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <div style="width: 16px; height: 16px; background: rgba(245,158,11,.3); border-radius: 4px;"></div>
            <strong style="font-size: 0.875rem;">Maintain (Top-Left)</strong>
          </div>
          <p style="font-size: 0.8125rem; color: var(--text-secondary); margin: 0;">High influence, lower impact. Keep satisfied. Consult on major decisions but less frequent engagement.</p>
        </div>
        
        <div>
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <div style="width: 16px; height: 16px; background: rgba(59,130,246,.3); border-radius: 4px;"></div>
            <strong style="font-size: 0.875rem;">Monitor (Bottom-Left)</strong>
          </div>
          <p style="font-size: 0.8125rem; color: var(--text-secondary); margin: 0;">Lower influence, lower impact. Monitor with minimal effort. Periodic general updates sufficient.</p>
        </div>
        
        <div>
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <div style="width: 16px; height: 16px; background: rgba(239,68,68,.3); border-radius: 4px;"></div>
            <strong style="font-size: 0.875rem;">Keep Informed (Bottom-Right)</strong>
          </div>
          <p style="font-size: 0.8125rem; color: var(--text-secondary); margin: 0;">Lower influence, high impact. Keep informed regularly. Directly affected by changes but limited decision power.</p>
        </div>
      </div>
    </div>
    
    <div style="margin-top: 24px;">
      <h4 style="margin-bottom: 12px; font-size: 1rem;">Legend</h4>
      <div class="grid grid-3" style="gap: 12px;">
        ${stakeholders.map((s, idx) => {
          const cat = STAKEHOLDER_CATEGORIES.find(c => c.id === (s.category || 'other'));
          const color = cat ? cat.color : '#6366f1';
          const initials = s.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
          
          return `
            <div style="display: flex; align-items: center; gap: 10px;">
              <div style="width: 32px; height: 32px; border-radius: 50%; background: ${color}; border: 2px solid white; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 0.7rem; box-shadow: 0 2px 4px rgba(0,0,0,.2);">
                ${initials}
              </div>
              <div>
                <div style="font-size: 0.875rem; font-weight: 600;">${escapeHtml(s.name)}</div>
                <div style="font-size: 0.75rem; color: var(--text-muted);">${escapeHtml(s.role)}</div>
              </div>
            </div>
          `;
        }).join("")}
      </div>
    </div>
  `;
  
  openModal("Stakeholder Influence/Impact Map", "Position stakeholders based on their influence and impact levels", body);
  
  // Make markers clickable
  setTimeout(() => {
    document.querySelectorAll(".stakeholder-marker").forEach(marker => {
      marker.addEventListener("click", (e) => {
        e.stopPropagation();
        const id = marker.dataset.stakeholderId;
        const s = state.stakeholders.find(sh => sh.id === id);
        if (s) {
          closeModal();
          setTimeout(() => openStakeholderModal(s), 100);
        }
      });
    });
  }, 100);
}

/* ============================================
   EVENT HANDLERS
   ============================================ */
function wireOrgChartPage() {
  // View Stakeholder Map button
  document.getElementById("viewStakeholderMap")?.addEventListener("click", () => {
    openInfluenceImpactMatrix();
  });
  
  // Toggle between hierarchy and category views
  document.getElementById("toggleOrgView")?.addEventListener("click", () => {
    document.getElementById("hierarchyView").style.display = "block";
    document.getElementById("categoryView").style.display = "none";
    toast("Showing hierarchy view");
  });
  
  document.getElementById("toggleCategoryView")?.addEventListener("click", () => {
    document.getElementById("hierarchyView").style.display = "none";
    document.getElementById("categoryView").style.display = "block";
    toast("Showing category view");
  });
  
  document.getElementById("exportOrgChart")?.addEventListener("click", () => {
    // Export as text-based org chart
    const stakeholders = state.stakeholders || [];
    const byLevel = {};
    const byCategory = {};
    
    stakeholders.forEach(s => {
      const level = s.hierarchyLevel || 0;
      if (!byLevel[level]) byLevel[level] = [];
      byLevel[level].push(s);
      
      const cat = s.category || "other";
      if (!byCategory[cat]) byCategory[cat] = [];
      byCategory[cat].push(s);
    });
    
    const lines = [];
    lines.push("ORGANIZATIONAL BREAKDOWN STRUCTURE");
    lines.push("=".repeat(50));
    lines.push("");
    
    // By Hierarchy
    lines.push("BY HIERARCHY LEVEL");
    lines.push("-".repeat(50));
    Object.keys(byLevel).sort((a, b) => parseInt(a) - parseInt(b)).forEach(levelNum => {
      const levelLabel = levelNum === '0' ? 'LEADERSHIP' : levelNum === '1' ? 'MANAGEMENT' : levelNum === '2' ? 'TEAM MEMBERS' : `LEVEL ${levelNum}`;
      lines.push("");
      lines.push(levelLabel);
      
      byLevel[levelNum].forEach(s => {
        lines.push(`  ‚Ä¢ ${s.name} - ${s.role}`);
        if (s.department) lines.push(`    Department: ${s.department}`);
        const cat = STAKEHOLDER_CATEGORIES.find(c => c.id === s.category);
        if (cat) lines.push(`    Category: ${cat.label}`);
        if (s.reportsTo) {
          const manager = stakeholders.find(sh => sh.id === s.reportsTo);
          if (manager) lines.push(`    Reports to: ${manager.name}`);
        }
      });
    });
    
    lines.push("");
    lines.push("");
    lines.push("BY FUNCTIONAL CATEGORY");
    lines.push("-".repeat(50));
    
    STAKEHOLDER_CATEGORIES.forEach(cat => {
      const members = byCategory[cat.id] || [];
      if (members.length === 0) return;
      
      lines.push("");
      lines.push(`${cat.icon} ${cat.label.toUpperCase()} (${members.length})`);
      members.forEach(s => {
        lines.push(`  ‚Ä¢ ${s.name} - ${s.role}`);
        if (s.department) lines.push(`    Department: ${s.department}`);
      });
    });
    
    const text = lines.join('\n');
    const blob = new Blob([text], { type: "text/plain" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `org-chart-${state.project.name || 'structure'}.txt`;
    a.click();
    URL.revokeObjectURL(url);
    toast("Org chart exported");
  });
  
  // Click on org nodes to edit
  document.querySelectorAll(".org-node").forEach(node => {
    node.addEventListener("click", () => {
      const id = node.dataset.stakeholderId;
      const s = state.stakeholders.find(sh => sh.id === id);
      if (s) openStakeholderModal(s);
    });
  });
}

function wireStakeholdersPage() {
  document.getElementById("addStakeholder")?.addEventListener("click", () => {
    openStakeholderModal();
  });
  
  document.getElementById("viewMapFromStakeholders")?.addEventListener("click", () => {
    openInfluenceImpactMatrix();
  });
  
  document.getElementById("viewRegister")?.addEventListener("click", () => {
    openStakeholderRegister();
  });

  document.querySelectorAll("[data-edit-stakeholder]").forEach(btn => {
    btn.addEventListener("click", () => {
      const id = btn.dataset.editStakeholder;
      const s = state.stakeholders.find(sh => sh.id === id);
      if (s) openStakeholderModal(s);
    });
  });

  document.querySelectorAll("[data-delete-stakeholder]").forEach(btn => {
    btn.addEventListener("click", () => {
      if (!confirm("Delete this stakeholder?")) return;
      const id = btn.dataset.deleteStakeholder;
      state.stakeholders = state.stakeholders.filter(s => s.id !== id);
      saveState();
      render();
      toast("Stakeholder deleted");
    });
  });

  document.getElementById("exportStakeholders")?.addEventListener("click", () => {
    const csv = "Name,Role,Department,Influence,Impact,Engagement,Notes\n" +
      state.stakeholders.map(s => 
        `"${s.name}","${s.role}","${s.department}",${s.influence},${s.impact},"${s.engagement}","${s.notes}"`
      ).join("\n");
    
    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "stakeholders.csv";
    a.click();
    URL.revokeObjectURL(url);
    toast("Stakeholders exported");
  });
}

function wireHomePage() {
  const nameInput = document.getElementById("projectName");
  const descInput = document.getElementById("projectDesc");
  
  nameInput?.addEventListener("input", () => {
    state.project.name = nameInput.value;
    saveState();
  });
  
  descInput?.addEventListener("input", () => {
    state.project.description = descInput.value;
    saveState();
  });
}

function wireRequirementsPage() {
  const fields = [
    { id: "reqProblem", key: "problem" },
    { id: "reqGoal", key: "goal" },
    { id: "reqInScope", key: "inScope" },
    { id: "reqOutScope", key: "outScope" },
    { id: "reqSuccess", key: "success" },
    { id: "reqConstraints", key: "constraints" },
    { id: "reqAssumptions", key: "assumptions" },
    { id: "reqRisks", key: "risks" }
  ];
  
  fields.forEach(({ id, key }) => {
    const el = document.getElementById(id);
    el?.addEventListener("input", () => {
      state.requirements[key] = el.value;
      saveState();
    });
  });
}

function wireProcessPage() {
  const fields = [
    { id: "procAsIs", key: "asIs" },
    { id: "procToBe", key: "toBe" },
    { id: "procDecisions", key: "decisions" },
    { id: "procExceptions", key: "exceptions" }
  ];
  
  fields.forEach(({ id, key }) => {
    const el = document.getElementById(id);
    el?.addEventListener("input", () => {
      state.process[key] = el.value;
      saveState();
    });
  });
}

function wireOutputPage() {
  document.getElementById("copyOutput")?.addEventListener("click", async () => {
    const output = generateOutput();
    try {
      await navigator.clipboard.writeText(output);
      toast("Copied to clipboard");
    } catch {
      toast("Copy failed - please select and copy manually");
    }
  });

  document.getElementById("downloadOutput")?.addEventListener("click", () => {
    const output = generateOutput();
    const blob = new Blob([output], { type: "text/plain" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `BAB-${state.project.name || 'output'}.txt`;
    a.click();
    URL.revokeObjectURL(url);
    toast("Downloaded");
  });

  document.getElementById("exportProject")?.addEventListener("click", () => {
    const json = JSON.stringify(state, null, 2);
    const blob = new Blob([json], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `BAB-${state.project.name || 'project'}.json`;
    a.click();
    URL.revokeObjectURL(url);
    toast("Project exported");
  });

  document.getElementById("importProject")?.addEventListener("click", () => {
    document.getElementById("importFile").click();
  });

  document.getElementById("importFile")?.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const imported = JSON.parse(reader.result);
        state = { ...structuredClone(DEFAULT_STATE), ...imported };
        saveState();
        render();
        toast("Project imported");
      } catch {
        toast("Invalid project file");
      }
    };
    reader.readAsText(file);
  });
}

/* ============================================
   RENDER
   ============================================ */
function render() {
  const app = document.getElementById("app");
  
  // Update nav
  document.querySelectorAll(".nav-btn").forEach(btn => {
    btn.classList.toggle("active", btn.dataset.route === state.route);
  });
  
  // Render view
  let html = "";
  switch (state.route) {
    case "home": html = viewHome(); break;
    case "stakeholders": html = viewStakeholders(); break;
    case "orgchart": html = viewOrgChart(); break;
    case "requirements": html = viewRequirements(); break;
    case "process": html = viewProcess(); break;
    case "output": html = viewOutput(); break;
    case "library": html = viewLibrary(); break;
    default: html = viewHome();
  }
  
  app.innerHTML = html;
  
  // Wire up page-specific events
  switch (state.route) {
    case "home": wireHomePage(); break;
    case "stakeholders": wireStakeholdersPage(); break;
    case "orgchart": wireOrgChartPage(); break;
    case "requirements": wireRequirementsPage(); break;
    case "process": wireProcessPage(); break;
    case "output": wireOutputPage(); break;
  }
}

/* ============================================
   INIT
   ============================================ */
render();
</script>

</body>
</html>